name: Frontend CI/CD Pipeline

on:
  push:
    tags:
      - 'v*'
      - 'frontend-v*'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•å’Œæ£€æŸ¥'
        required: false
        default: false
        type: boolean

env:
  IMAGE_NAME: code-reader-frontend
  REGISTRY: ghcr.io
  NAMESPACE: code-reader
  DEPLOYMENT_NAME: code-reader-frontend

jobs:

  build-and-test:
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: å®‰è£…pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
        
    - name: è·å–pnpm storeç›®å½•
      id: pnpm-cache
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT
        
    - name: è®¾ç½®pnpmç¼“å­˜
      uses: actions/cache@v4
      with:
        path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-
        
    - name: å®‰è£…å‰ç«¯ä¾èµ–
      working-directory: ./frontend
      run: pnpm install --frozen-lockfile
        
    - name: ä»£ç è´¨é‡æ£€æŸ¥
      working-directory: ./frontend
      run: |
        # TypeScript ç±»å‹æ£€æŸ¥
        echo "è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥..."
        npx tsc --noEmit || echo "TypeScript ç±»å‹æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
        
        # ESLint æ£€æŸ¥ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
        if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ]; then
          echo "è¿è¡Œ ESLint æ£€æŸ¥..."
          npx eslint src/ --ext .ts,.tsx || echo "ESLint æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
        else
          echo "æœªæ‰¾åˆ° ESLint é…ç½®ï¼Œè·³è¿‡ ESLint æ£€æŸ¥"
        fi
        
    - name: æ„å»ºå‰ç«¯åº”ç”¨
      working-directory: ./frontend
      run: |
        echo "æ„å»ºå‰ç«¯åº”ç”¨..."
        pnpm run build
        
        # æ£€æŸ¥æ„å»ºäº§ç‰©
        if [ -d "build" ]; then
          echo "âœ… å‰ç«¯æ„å»ºæˆåŠŸï¼Œæ„å»ºäº§ç‰©ä½äº build/ ç›®å½•"
          ls -la build/
        else
          echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ°æ„å»ºäº§ç‰©"
          exit 1
        fi
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/build/
        retention-days: 7


  docker-build-push:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: |
      always() && 
      (needs.build-and-test.result == 'success' || inputs.skip_tests) && 
      (startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch')
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    outputs:
      image-tag: ${{ steps.image-info.outputs.image-tag }}
      full-image-name: ${{ steps.image-info.outputs.full-image-name }}
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: frontend/build/
      
    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ç™»å½•GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ç”Ÿæˆé•œåƒæ ‡ç­¾å’Œå…ƒæ•°æ®
      id: image-info
      run: |
        SHORT_SHA=${GITHUB_SHA::7}
        
        # æ ¹æ®è§¦å‘æ–¹å¼ç”Ÿæˆæ ‡ç­¾
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          # Tag è§¦å‘ï¼šä½¿ç”¨ tag åç§°
          TAG_NAME=${GITHUB_REF#refs/tags/}
          IMAGE_TAG="${TAG_NAME}-${SHORT_SHA}"
        elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
          # Main åˆ†æ”¯ï¼šä½¿ç”¨ main å’Œæ—¶é—´æˆ³
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          IMAGE_TAG="main-${TIMESTAMP}-${SHORT_SHA}"
        else
          # æ‰‹åŠ¨è§¦å‘æˆ–å…¶ä»–åˆ†æ”¯ï¼šä½¿ç”¨åˆ†æ”¯å
          BRANCH_NAME=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}
          BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g')
          IMAGE_TAG="${BRANCH_NAME}-${SHORT_SHA}"
        fi
        
        # ä½¿ç”¨ä»“åº“ownerä½œä¸ºç»„ç»‡åï¼Œè½¬æ¢ä¸ºå°å†™ï¼ˆDockerè¦æ±‚ï¼‰
        REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        FULL_IMAGE_NAME="${{ env.REGISTRY }}/${REPO_OWNER}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
        LATEST_IMAGE_NAME="${{ env.REGISTRY }}/${REPO_OWNER}/${{ env.IMAGE_NAME }}:latest"
        
        echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "full-image-name=${FULL_IMAGE_NAME}" >> $GITHUB_OUTPUT
        echo "latest-image-name=${LATEST_IMAGE_NAME}" >> $GITHUB_OUTPUT
        
    - name: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./frontend/Dockerfile
        push: true
        tags: |
          ${{ steps.image-info.outputs.full-image-name }}
          ${{ steps.image-info.outputs.latest-image-name }}
        cache-from: type=gha
        cache-to: type=gha,mode=max




  deploy-to-kubernetes:
    needs: docker-build-push
    runs-on: ubuntu-latest
    # ä»… tag è§¦å‘æ—¶è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: ç¡®å®šéƒ¨ç½²ç¯å¢ƒ
      id: deploy-env
      run: |
        # ç¡®å®šå‘½åç©ºé—´å’Œéƒ¨ç½²åç§°
        NAMESPACE="code-reader"
        DEPLOYMENT="code-reader-frontend"
        ENV_NAME="ç”Ÿäº§ç¯å¢ƒ"
        
        echo "namespace=${NAMESPACE}" >> $GITHUB_OUTPUT
        echo "deployment=${DEPLOYMENT}" >> $GITHUB_OUTPUT
        echo "env-name=${ENV_NAME}" >> $GITHUB_OUTPUT
      
    - name: é…ç½® kubectl
      env:
        K8S_TOKEN: ${{ secrets.K8S_TOKEN }}
        K8S_API_URL: ${{ secrets.K8S_API_URL }}
      run: |
        # å®‰è£… kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        # é…ç½® kubectl
        kubectl config set-cluster k8s-cluster --server="$K8S_API_URL" --insecure-skip-tls-verify=true
        kubectl config set-credentials github-actions --token="$K8S_TOKEN"
        kubectl config set-context default --cluster=k8s-cluster --user=github-actions --namespace=${{ steps.deploy-env.outputs.namespace }}
        kubectl config use-context default
        
        # éªŒè¯è¿æ¥
        kubectl cluster-info
      
    - name: åº”ç”¨ Kubernetes é…ç½®
      run: |
        # åº”ç”¨åŸºç¡€é…ç½®
        kubectl apply -f k8s/00-namespace.yaml
        
        # ä»…åœ¨ ConfigMap ä¸å­˜åœ¨æ—¶åˆ›å»ºï¼ˆé¿å…è¦†ç›–å·²é…ç½®çš„å€¼ï¼‰
        kubectl get configmap code-reader-frontend-nginx-config -n code-reader >/dev/null 2>&1 || kubectl apply -f k8s/03-config.yaml
        
        kubectl apply -f k8s/04-pvc.yaml
        kubectl apply -f k8s/05-rbac.yaml
        
    - name: æ›´æ–°å‰ç«¯é•œåƒå¹¶éƒ¨ç½²
      env:
        IMAGE_TAG: ${{ needs.docker-build-push.outputs.full-image-name }}
        NAMESPACE: ${{ steps.deploy-env.outputs.namespace }}
        DEPLOYMENT: ${{ steps.deploy-env.outputs.deployment }}
      run: |
        # å¤‡ä»½åŸå§‹æ–‡ä»¶
        cp k8s/01-frontend.yaml k8s/01-frontend.yaml.bak
        
        # åªæ›´æ–°ç”Ÿäº§ç¯å¢ƒçš„é•œåƒ
        sed -i "0,/image:.*code-reader-frontend.*/s||image: $IMAGE_TAG|" k8s/01-frontend.yaml
        
        # åº”ç”¨å‰ç«¯é…ç½®
        kubectl apply -f k8s/01-frontend.yaml
        
        # æ¢å¤åŸå§‹æ–‡ä»¶
        mv k8s/01-frontend.yaml.bak k8s/01-frontend.yaml
        
        echo "Frontend deployment updated with image: $IMAGE_TAG"

    - name: Verify deployment
      env:
        NAMESPACE: ${{ steps.deploy-env.outputs.namespace }}
        DEPLOYMENT: ${{ steps.deploy-env.outputs.deployment }}
      run: |
        # Wait for rollout to complete
        echo "Waiting for frontend deployment to complete..."
        kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE --timeout=5m
        
        # æ˜¾ç¤ºéƒ¨ç½²çŠ¶æ€
        kubectl get pods -n $NAMESPACE -l app=$DEPLOYMENT
        kubectl get services -n $NAMESPACE -l app=$DEPLOYMENT
        
    - name: å‰ç«¯éƒ¨ç½²æˆåŠŸé€šçŸ¥
      env:
        ENV_NAME: ${{ steps.deploy-env.outputs.env-name }}
        NAMESPACE: ${{ steps.deploy-env.outputs.namespace }}
        DEPLOYMENT: ${{ steps.deploy-env.outputs.deployment }}
      run: |
        echo "ğŸ‰ å‰ç«¯${ENV_NAME}éƒ¨ç½²æˆåŠŸ!"
        echo "é•œåƒ: ${{ needs.docker-build-push.outputs.full-image-name }}"
        echo "å‘½åç©ºé—´: $NAMESPACE"
        echo "Deployment: $DEPLOYMENT"
        
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "æ ‡ç­¾: $TAG_NAME"
        elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
          echo "åˆ†æ”¯: main"
        fi


  deploy-to-test-kubernetes:
    needs: docker-build-push
    runs-on: ubuntu-latest
    # ä»…æ‰‹åŠ¨è§¦å‘
    if: github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: é…ç½® kubectl
      env:
        K8S_TOKEN: ${{ secrets.K8S_TOKEN }}
        K8S_API_URL: ${{ secrets.K8S_API_URL }}
      run: |
        # å®‰è£… kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        # é…ç½® kubectl
        kubectl config set-cluster k8s-cluster --server="$K8S_API_URL" --insecure-skip-tls-verify=true
        kubectl config set-credentials github-actions --token="$K8S_TOKEN"
        kubectl config set-context default --cluster=k8s-cluster --user=github-actions --namespace=code-reader
        kubectl config use-context default
        
        # éªŒè¯è¿æ¥
        kubectl cluster-info

    - name: åº”ç”¨ Kubernetes é…ç½®
      run: |
        # åº”ç”¨åŸºç¡€é…ç½®
        kubectl apply -f k8s/00-namespace.yaml
        
        # ä»…åœ¨ ConfigMap ä¸å­˜åœ¨æ—¶åˆ›å»ºï¼ˆé¿å…è¦†ç›–å·²é…ç½®çš„å€¼ï¼‰
        kubectl get configmap code-reader-frontend-nginx-config-test -n code-reader >/dev/null 2>&1 || kubectl apply -f k8s/03-config.yaml
        
        kubectl apply -f k8s/04-pvc.yaml
        kubectl apply -f k8s/05-rbac.yaml

    - name: æ›´æ–°æµ‹è¯•å‰ç«¯é•œåƒå¹¶éƒ¨ç½²
      env:
        IMAGE_TAG: ${{ needs.docker-build-push.outputs.full-image-name }}
      run: |
        # å¤‡ä»½åŸå§‹æ–‡ä»¶
        cp k8s/01-frontend.yaml k8s/01-frontend.yaml.bak
        
        # åªæ›´æ–°æµ‹è¯•ç¯å¢ƒçš„é•œåƒï¼ˆç¬¬äºŒä¸ªåŒ¹é…ï¼‰
        sed -i "0,/image:.*code-reader-frontend.*/! {0,/image:.*code-reader-frontend.*/s||image: $IMAGE_TAG|}" k8s/01-frontend.yaml
        
        # åº”ç”¨å‰ç«¯é…ç½®
        kubectl apply -f k8s/01-frontend.yaml
        
        # æ¢å¤åŸå§‹æ–‡ä»¶
        mv k8s/01-frontend.yaml.bak k8s/01-frontend.yaml
        
        echo "Test frontend deployment updated with image: $IMAGE_TAG"

    - name: Verify test deployment
      run: |
        # ç­‰å¾…æµ‹è¯•éƒ¨ç½²å®Œæˆ
        echo "Waiting for test frontend deployment to complete..."
        kubectl rollout status deployment/code-reader-frontend-test -n code-reader --timeout=5m
        
        # æ˜¾ç¤ºéƒ¨ç½²çŠ¶æ€
        kubectl get pods -n code-reader -l app=code-reader-frontend-test
        kubectl get services -n code-reader -l app=code-reader-frontend-test

    - name: å‰ç«¯æµ‹è¯•éƒ¨ç½²æˆåŠŸé€šçŸ¥
      run: |
        BRANCH_NAME=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}
        echo "ğŸ§ª å‰ç«¯æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æˆåŠŸ!"
        echo "åˆ†æ”¯: $BRANCH_NAME"
        echo "é•œåƒ: ${{ needs.docker-build-push.outputs.full-image-name }}"
        echo "å‘½åç©ºé—´: code-reader"
        echo "Deployment: code-reader-frontend-test"
