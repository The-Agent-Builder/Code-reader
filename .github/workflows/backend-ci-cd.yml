name: Backend CI/CD Pipeline

on:
  push:
    tags:
      - 'v*'
      - 'backend-v*'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•å’Œæ£€æŸ¥'
        required: false
        default: false
        type: boolean

env:
  IMAGE_NAME: code-reader-backend
  REGISTRY: ghcr.io
  NAMESPACE: code-reader
  DEPLOYMENT_NAME: code-reader-backend

jobs:

  build-and-test:
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests && (inputs.deploy_backend == true || github.event_name != 'workflow_dispatch') }}

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: å®‰è£…uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: å®‰è£…ä¾èµ–
      run: |
        uv venv
        source .venv/bin/activate
        uv sync --frozen
        
    - name: ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        source .venv/bin/activate
        # ç¼–è¯‘æ£€æŸ¥ä¸»è¦ Python æ–‡ä»¶
        echo "æ£€æŸ¥ä¸»è¦ Python æ–‡ä»¶è¯­æ³•..."
        python -m py_compile backend/main.py
        python -m py_compile backend/routers.py
        python -m py_compile backend/models.py
        python -m py_compile backend/database.py
        python -m py_compile backend/config.py

        # æ£€æŸ¥æ ¸å¿ƒæ¨¡å—
        echo "æ£€æŸ¥æ ¸å¿ƒæ¨¡å—..."
        python -c "import src.flows; print('src.flows æ¨¡å—å¯¼å…¥æˆåŠŸ')" || echo "src.flows æ¨¡å—å¯¼å…¥å¤±è´¥"
        python -c "import src.nodes; print('src.nodes æ¨¡å—å¯¼å…¥æˆåŠŸ')" || echo "src.nodes æ¨¡å—å¯¼å…¥å¤±è´¥"
        python -c "import src.utils; print('src.utils æ¨¡å—å¯¼å…¥æˆåŠŸ')" || echo "src.utils æ¨¡å—å¯¼å…¥å¤±è´¥"

        # æ£€æŸ¥å…³é”®æ–‡ä»¶è¯­æ³•
        echo "æ£€æŸ¥å…³é”®æ–‡ä»¶è¯­æ³•..."
        find src -name "*.py" -exec python -m py_compile {} \; || echo "éƒ¨åˆ† src æ–‡ä»¶ç¼–è¯‘å¤±è´¥"
        find backend -name "*.py" -exec python -m py_compile {} \; || echo "éƒ¨åˆ† backend æ–‡ä»¶ç¼–è¯‘å¤±è´¥"
        
    - name: è¿è¡Œæµ‹è¯•
      run: |
        source .venv/bin/activate
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨æµ‹è¯•ç›®å½•
        if [ -d "test" ]; then
          echo "è¿è¡Œæµ‹è¯•å¥—ä»¶..."
          python -m pytest test/ -v || echo "éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
        else
          echo "æœªæ‰¾åˆ°æµ‹è¯•ç›®å½•ï¼Œè·³è¿‡æµ‹è¯•"
        fi

        # è¿è¡ŒåŸºæœ¬åŠŸèƒ½æµ‹è¯•
        echo "è¿è¡ŒåŸºæœ¬åŠŸèƒ½æµ‹è¯•..."
        python -c "
        import sys
        try:
            import backend.main
            print('âœ… backend.main æ¨¡å—å¯¼å…¥æˆåŠŸ')
        except Exception as e:
            print(f'âŒ backend.main æ¨¡å—å¯¼å…¥å¤±è´¥: {e}')
            sys.exit(1)

        try:
            import backend.routers
            print('âœ… backend.routers æ¨¡å—å¯¼å…¥æˆåŠŸ')
        except Exception as e:
            print(f'âŒ backend.routers æ¨¡å—å¯¼å…¥å¤±è´¥: {e}')
            sys.exit(1)

        try:
            import backend.models
            print('âœ… backend.models æ¨¡å—å¯¼å…¥æˆåŠŸ')
        except Exception as e:
            print(f'âŒ backend.models æ¨¡å—å¯¼å…¥å¤±è´¥: {e}')
            sys.exit(1)

        try:
            import backend.database
            print('âœ… backend.database æ¨¡å—å¯¼å…¥æˆåŠŸ')
        except Exception as e:
            print(f'âŒ backend.database æ¨¡å—å¯¼å…¥å¤±è´¥: {e}')
            sys.exit(1)

        print('âœ… æ‰€æœ‰åŸºæœ¬åŠŸèƒ½æµ‹è¯•é€šè¿‡')
        "


  docker-build-push:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: |
      always() && 
      (needs.build-and-test.result == 'success' || inputs.skip_tests) && 
      (startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch')
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    outputs:
      image-tag: ${{ steps.image-info.outputs.image-tag }}
      full-image-name: ${{ steps.image-info.outputs.full-image-name }}
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ç™»å½•GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ç”Ÿæˆé•œåƒæ ‡ç­¾å’Œå…ƒæ•°æ®
      id: image-info
      run: |
        SHORT_SHA=${GITHUB_SHA::7}
        
        # æ ¹æ®è§¦å‘æ–¹å¼ç”Ÿæˆæ ‡ç­¾
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          # Tag è§¦å‘ï¼šä½¿ç”¨ tag åç§°
          TAG_NAME=${GITHUB_REF#refs/tags/}
          IMAGE_TAG="${TAG_NAME}-${SHORT_SHA}"
        elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
          # Main åˆ†æ”¯ï¼šä½¿ç”¨ main å’Œæ—¶é—´æˆ³
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          IMAGE_TAG="main-${TIMESTAMP}-${SHORT_SHA}"
        else
          # æ‰‹åŠ¨è§¦å‘æˆ–å…¶ä»–åˆ†æ”¯ï¼šä½¿ç”¨åˆ†æ”¯å
          BRANCH_NAME=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}
          BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g')
          IMAGE_TAG="${BRANCH_NAME}-${SHORT_SHA}"
        fi
        
        # ä½¿ç”¨ä»“åº“ownerä½œä¸ºç»„ç»‡åï¼Œè½¬æ¢ä¸ºå°å†™ï¼ˆDockerè¦æ±‚ï¼‰
        REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        FULL_IMAGE_NAME="${{ env.REGISTRY }}/${REPO_OWNER}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
        LATEST_IMAGE_NAME="${{ env.REGISTRY }}/${REPO_OWNER}/${{ env.IMAGE_NAME }}:latest"
        
        echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "full-image-name=${FULL_IMAGE_NAME}" >> $GITHUB_OUTPUT
        echo "latest-image-name=${LATEST_IMAGE_NAME}" >> $GITHUB_OUTPUT
        
    - name: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ steps.image-info.outputs.full-image-name }}
          ${{ steps.image-info.outputs.latest-image-name }}
        cache-from: type=gha
        cache-to: type=gha,mode=max




  deploy-to-kubernetes:
    needs: docker-build-push
    runs-on: ubuntu-latest
    # ä»… tag è§¦å‘æ—¶è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: ç¡®å®šéƒ¨ç½²ç¯å¢ƒ
      id: deploy-env
      run: |
        # ç¡®å®šå‘½åç©ºé—´å’Œéƒ¨ç½²åç§°
        NAMESPACE="code-reader"
        DEPLOYMENT="code-reader-backend"
        ENV_NAME="ç”Ÿäº§ç¯å¢ƒ"
        
        echo "namespace=${NAMESPACE}" >> $GITHUB_OUTPUT
        echo "deployment=${DEPLOYMENT}" >> $GITHUB_OUTPUT
        echo "env-name=${ENV_NAME}" >> $GITHUB_OUTPUT
      
    - name: é…ç½® kubectl
      env:
        K8S_TOKEN: ${{ secrets.K8S_TOKEN }}
        K8S_API_URL: ${{ secrets.K8S_API_URL }}
      run: |
        # å®‰è£… kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        # é…ç½® kubectl
        kubectl config set-cluster k8s-cluster --server="$K8S_API_URL" --insecure-skip-tls-verify=true
        kubectl config set-credentials github-actions --token="$K8S_TOKEN"
        kubectl config set-context default --cluster=k8s-cluster --user=github-actions --namespace=${{ steps.deploy-env.outputs.namespace }}
        kubectl config use-context default
        
        # éªŒè¯è¿æ¥
        kubectl cluster-info
      
    - name: åº”ç”¨ Kubernetes é…ç½®
      run: |
        # åº”ç”¨åŸºç¡€é…ç½®
        kubectl apply -f k8s/00-namespace.yaml
        
        # ä»…åœ¨ ConfigMap ä¸å­˜åœ¨æ—¶åˆ›å»ºï¼ˆä¸è¦†ç›–å·²æœ‰é…ç½®ï¼‰
        kubectl get configmap code-reader-config -n code-reader >/dev/null 2>&1 || kubectl apply -f k8s/03-config.yaml
        
        kubectl apply -f k8s/04-pvc.yaml
        kubectl apply -f k8s/05-rbac.yaml
        
    - name: æ›´æ–°åç«¯é•œåƒå¹¶éƒ¨ç½²
      env:
        IMAGE_TAG: ${{ needs.docker-build-push.outputs.full-image-name }}
        NAMESPACE: ${{ steps.deploy-env.outputs.namespace }}
        DEPLOYMENT: ${{ steps.deploy-env.outputs.deployment }}
      run: |
        # å¤‡ä»½åŸå§‹æ–‡ä»¶
        cp k8s/02-backend.yaml k8s/02-backend.yaml.bak
        
        # åªæ›´æ–°ç”Ÿäº§ç¯å¢ƒçš„é•œåƒ
        sed -i "0,/image:.*code-reader-backend.*/s||image: $IMAGE_TAG|" k8s/02-backend.yaml
        
        # åº”ç”¨åç«¯é…ç½®
        kubectl apply -f k8s/02-backend.yaml
        
        # æ¢å¤åŸå§‹æ–‡ä»¶
        mv k8s/02-backend.yaml.bak k8s/02-backend.yaml
        
        echo "Backend deployment updated with image: $IMAGE_TAG"

    - name: Verify deployment
      env:
        NAMESPACE: ${{ steps.deploy-env.outputs.namespace }}
        DEPLOYMENT: ${{ steps.deploy-env.outputs.deployment }}
      run: |
        # Wait for rollout to complete
        echo "Waiting for backend deployment to complete..."
        kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE --timeout=5m
        
        # æ˜¾ç¤ºéƒ¨ç½²çŠ¶æ€
        kubectl get pods -n $NAMESPACE -l app=$DEPLOYMENT
        kubectl get services -n $NAMESPACE -l app=$DEPLOYMENT
        
    - name: åç«¯éƒ¨ç½²æˆåŠŸé€šçŸ¥
      env:
        ENV_NAME: ${{ steps.deploy-env.outputs.env-name }}
        NAMESPACE: ${{ steps.deploy-env.outputs.namespace }}
        DEPLOYMENT: ${{ steps.deploy-env.outputs.deployment }}
      run: |
        echo "ğŸ‰ åç«¯${ENV_NAME}éƒ¨ç½²æˆåŠŸ!"
        echo "é•œåƒ: ${{ needs.docker-build-push.outputs.full-image-name }}"
        echo "å‘½åç©ºé—´: $NAMESPACE"
        echo "Deployment: $DEPLOYMENT"
        
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "æ ‡ç­¾: $TAG_NAME"
        elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
          echo "åˆ†æ”¯: main"
        fi


  deploy-to-test-kubernetes:
    needs: docker-build-push
    runs-on: ubuntu-latest
    # ä»…æ‰‹åŠ¨è§¦å‘
    if: github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: é…ç½® kubectl
      env:
        K8S_TOKEN: ${{ secrets.K8S_TOKEN }}
        K8S_API_URL: ${{ secrets.K8S_API_URL }}
      run: |
        # å®‰è£… kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        # é…ç½® kubectl
        kubectl config set-cluster k8s-cluster --server="$K8S_API_URL" --insecure-skip-tls-verify=true
        kubectl config set-credentials github-actions --token="$K8S_TOKEN"
        kubectl config set-context default --cluster=k8s-cluster --user=github-actions --namespace=code-reader-test
        kubectl config use-context default
        
        # éªŒè¯è¿æ¥
        kubectl cluster-info

    - name: åº”ç”¨ Kubernetes é…ç½®
      run: |
        # åº”ç”¨åŸºç¡€é…ç½®
        kubectl apply -f k8s/00-namespace.yaml
        
        # ä»…åœ¨ ConfigMap ä¸å­˜åœ¨æ—¶åˆ›å»ºï¼ˆä¸è¦†ç›–å·²æœ‰é…ç½®ï¼‰
        kubectl get configmap code-reader-test-config -n code-reader-test >/dev/null 2>&1 || kubectl apply -f k8s/03-config.yaml
        
        kubectl apply -f k8s/04-pvc.yaml
        kubectl apply -f k8s/05-rbac.yaml

    - name: æ›´æ–°æµ‹è¯•åç«¯é•œåƒå¹¶éƒ¨ç½²
      env:
        IMAGE_TAG: ${{ needs.docker-build-push.outputs.full-image-name }}
      run: |
        # å¤‡ä»½åŸå§‹æ–‡ä»¶
        cp k8s/02-backend.yaml k8s/02-backend.yaml.bak
        
        # åªæ›´æ–°æµ‹è¯•ç¯å¢ƒçš„é•œåƒï¼ˆç¬¬äºŒä¸ªåŒ¹é…ï¼‰
        sed -i "0,/image:.*code-reader-backend.*/! {0,/image:.*code-reader-backend.*/s||image: $IMAGE_TAG|}" k8s/02-backend.yaml
        
        # åº”ç”¨åç«¯é…ç½®
        kubectl apply -f k8s/02-backend.yaml
        
        # æ¢å¤åŸå§‹æ–‡ä»¶
        mv k8s/02-backend.yaml.bak k8s/02-backend.yaml
        
        echo "Test backend deployment updated with image: $IMAGE_TAG"

    - name: Verify test deployment
      run: |
        # ç­‰å¾…æµ‹è¯•éƒ¨ç½²å®Œæˆ
        echo "Waiting for test backend deployment to complete..."
        kubectl rollout status deployment/code-reader-backend-test -n code-reader-test --timeout=5m
        
        # æ˜¾ç¤ºéƒ¨ç½²çŠ¶æ€
        kubectl get pods -n code-reader-test -l app=code-reader-backend-test
        kubectl get services -n code-reader-test -l app=code-reader-backend-test

    - name: åç«¯æµ‹è¯•éƒ¨ç½²æˆåŠŸé€šçŸ¥
      run: |
        BRANCH_NAME=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}
        echo "ğŸ§ª åç«¯æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æˆåŠŸ!"
        echo "åˆ†æ”¯: $BRANCH_NAME"
        echo "é•œåƒ: ${{ needs.docker-build-push.outputs.full-image-name }}"
        echo "å‘½åç©ºé—´: code-reader-test"
        echo "Deployment: code-reader-backend-test"
