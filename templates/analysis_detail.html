<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <!-- 版本: 20250804-2 - 修复代码缩进和搜索高亮 -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>分析详情 - GitHub 代码仓库分析工具</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="/static/css/style.css" rel="stylesheet" />
    <style>
      .code-block {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 0.375rem;
        padding: 1rem;
        margin: 0.5rem 0;
        overflow-x: auto;
      }

      .code-block pre {
        margin: 0;
        white-space: pre;
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        font-size: 0.875rem;
        line-height: 1.4;
        tab-size: 4;
      }

      .code-block code {
        background: none;
        padding: 0;
        font-size: inherit;
        color: inherit;
      }

      .search-highlight {
        background-color: #fff3cd;
        color: #856404;
        padding: 1px 2px;
        border-radius: 2px;
        font-weight: bold;
      }
      .analysis-section {
        margin-bottom: 2rem;
      }
      .file-analysis {
        border-left: 4px solid #007bff;
        padding-left: 1rem;
        margin-bottom: 1.5rem;
      }
      .element-card {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
      }
      .element-header {
        background-color: #f8f9fa;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
      }
      .element-content {
        padding: 1rem;
      }
      .language-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }

      /* 语言分布样式 */
      .language-item {
        padding: 0.75rem;
        border-radius: 0.5rem;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        transition: all 0.2s ease;
      }

      .language-item:hover {
        background-color: #e9ecef;
        border-color: #dee2e6;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .language-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
      }

      .language-name {
        font-size: 0.95rem;
        color: #495057;
      }

      .percentage-text {
        font-size: 1rem;
        color: #212529;
      }

      .progress {
        background-color: #e9ecef;
        border-radius: 3px;
      }

      .progress-bar {
        border-radius: 3px;
        transition: width 0.6s ease;
      }

      /* 语言分布容器 */
      #languageDistribution {
        max-height: 400px;
        overflow-y: auto;
      }

      #languageDistribution::-webkit-scrollbar {
        width: 6px;
      }

      #languageDistribution::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }

      #languageDistribution::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
      }

      #languageDistribution::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="fab fa-github me-2"></i>
          GitHub 代码仓库分析工具
        </a>
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="/">
            <i class="fas fa-home me-1"></i>
            返回首页
          </a>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <!-- 加载状态 -->
      <div id="loadingContainer" class="text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">加载中...</span>
        </div>
        <p class="mt-2">正在加载分析详情...</p>
      </div>

      <!-- 错误状态 -->
      <div id="errorContainer" class="alert alert-danger d-none">
        <h4 class="alert-heading">
          <i class="fas fa-exclamation-triangle me-2"></i>
          加载失败
        </h4>
        <p id="errorMessage">未知错误</p>
        <hr />
        <button class="btn btn-outline-danger" onclick="location.reload()">
          <i class="fas fa-redo me-1"></i>
          重新加载
        </button>
      </div>

      <!-- 分析详情内容 -->
      <div id="detailContainer" class="d-none">
        <!-- 仓库基本信息 -->
        <div class="card mb-4">
          <div class="card-header">
            <h4 class="mb-0">
              <i class="fab fa-github me-2"></i>
              仓库信息
            </h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-8">
                <h5 id="repoName" class="mb-2">仓库名称</h5>
                <p id="repoDescription" class="text-muted mb-3">仓库描述</p>
                <div class="d-flex flex-wrap gap-2 mb-3">
                  <span class="badge bg-primary" id="mainLanguage"
                    >主要语言</span
                  >
                  <span class="badge bg-info">
                    <i class="fas fa-star me-1"></i>
                    <span id="starCount">0</span> Stars
                  </span>
                  <span class="badge bg-info">
                    <i class="fas fa-code-branch me-1"></i>
                    <span id="forkCount">0</span> Forks
                  </span>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-end">
                  <p class="text-muted mb-1">
                    <i class="fas fa-calendar-plus me-1"></i>
                    创建时间: <span id="createdAt">-</span>
                  </p>
                  <p class="text-muted mb-1">
                    <i class="fas fa-calendar-alt me-1"></i>
                    更新时间: <span id="updatedAt">-</span>
                  </p>
                  <p class="text-muted mb-1">
                    <i class="fas fa-clock me-1"></i>
                    分析时间: <span id="analysisTime">-</span>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 分析统计 -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-chart-bar me-2"></i>
              分析统计
            </h5>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-3">
                <div class="border rounded p-3">
                  <h3 class="text-primary mb-1" id="totalFiles">0</h3>
                  <p class="text-muted mb-0">
                    <i class="fas fa-file-code me-1"></i>
                    文件数量
                  </p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="border rounded p-3">
                  <h3 class="text-success mb-1" id="totalFunctions">0</h3>
                  <p class="text-muted mb-0">
                    <i class="fas fa-function me-1"></i>
                    函数数量
                  </p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="border rounded p-3">
                  <h3 class="text-info mb-1" id="totalClasses">0</h3>
                  <p class="text-muted mb-0">
                    <i class="fas fa-cube me-1"></i>
                    类数量
                  </p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="border rounded p-3">
                  <h3 class="text-warning mb-1" id="languageCount">0</h3>
                  <p class="text-muted mb-0">
                    <i class="fas fa-code me-1"></i>
                    编程语言
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 语言分布 -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-chart-pie me-2"></i>
              语言分布
            </h5>
          </div>
          <div class="card-body">
            <div id="languageDistribution">
              <!-- 语言分布将通过JavaScript动态生成 -->
            </div>
          </div>
        </div>

        <!-- 代码分析结果 -->
        <div class="card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="fas fa-code me-2"></i>
                代码分析结果
                <span id="analysisCount" class="badge bg-secondary ms-2"
                  >0</span
                >
              </h5>
              <div class="d-flex gap-2">
                <button
                  class="btn btn-outline-secondary btn-sm"
                  onclick="toggleSearchPanel()"
                >
                  <i class="fas fa-search me-1"></i>
                  搜索
                </button>
                <button
                  class="btn btn-outline-secondary btn-sm"
                  onclick="toggleFilterPanel()"
                >
                  <i class="fas fa-filter me-1"></i>
                  筛选
                </button>
              </div>
            </div>
          </div>

          <!-- 搜索和筛选面板 -->
          <div id="searchPanel" class="card-body border-bottom bg-light d-none">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="searchInput" class="form-label">
                  <i class="fas fa-search me-1"></i>
                  搜索内容
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="searchInput"
                  placeholder="搜索标题、描述、代码..."
                  oninput="performSearch()"
                />
              </div>
              <div class="col-md-3">
                <label for="languageFilter" class="form-label">
                  <i class="fas fa-code me-1"></i>
                  编程语言
                </label>
                <select
                  class="form-select"
                  id="languageFilter"
                  onchange="performSearch()"
                >
                  <option value="">所有语言</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="sourceFilter" class="form-label">
                  <i class="fas fa-file me-1"></i>
                  来源文件
                </label>
                <select
                  class="form-select"
                  id="sourceFilter"
                  onchange="performSearch()"
                >
                  <option value="">所有文件</option>
                </select>
              </div>
            </div>
            <div class="row g-3 mt-2">
              <div class="col-md-12">
                <div class="d-flex gap-2 align-items-center">
                  <span class="text-muted">快速筛选:</span>
                  <button
                    class="btn btn-outline-primary btn-sm"
                    onclick="quickFilter('function')"
                  >
                    <i class="fas fa-function me-1"></i>
                    函数
                  </button>
                  <button
                    class="btn btn-outline-success btn-sm"
                    onclick="quickFilter('class')"
                  >
                    <i class="fas fa-cube me-1"></i>
                    类
                  </button>
                  <button
                    class="btn btn-outline-info btn-sm"
                    onclick="quickFilter('python')"
                  >
                    <i class="fab fa-python me-1"></i>
                    Python
                  </button>
                  <button
                    class="btn btn-outline-warning btn-sm"
                    onclick="quickFilter('javascript')"
                  >
                    <i class="fab fa-js me-1"></i>
                    JavaScript
                  </button>
                  <button
                    class="btn btn-outline-secondary btn-sm"
                    onclick="clearFilters()"
                  >
                    <i class="fas fa-times me-1"></i>
                    清除
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- 搜索结果统计 -->
          <div
            id="searchStats"
            class="card-body border-bottom bg-info text-white d-none"
          >
            <div class="d-flex justify-content-between align-items-center">
              <span>
                <i class="fas fa-search me-1"></i>
                搜索结果: <span id="searchResultCount">0</span> 项
              </span>
              <button
                class="btn btn-outline-light btn-sm"
                onclick="clearSearch()"
              >
                <i class="fas fa-times me-1"></i>
                清除搜索
              </button>
            </div>
          </div>

          <div class="card-body">
            <div id="codeAnalysisContainer">
              <!-- 代码分析结果将通过JavaScript动态生成 -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // 从URL获取分析ID
      const analysisId = window.location.pathname.split("/").pop();

      // 页面加载完成后获取分析详情
      document.addEventListener("DOMContentLoaded", function () {
        loadAnalysisDetail(analysisId);
      });

      // 加载分析详情
      async function loadAnalysisDetail(analysisId) {
        try {
          const response = await fetch(`/api/analysis/${analysisId}/result`);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          displayAnalysisDetail(data);
        } catch (error) {
          console.error("加载分析详情失败:", error);
          showError(error.message);
        }
      }

      // 显示分析详情
      function displayAnalysisDetail(data) {
        console.log("Analysis data:", data); // 调试日志

        // 保存全局数据供其他函数使用
        window.analysisData = data;

        // 隐藏加载状态
        document.getElementById("loadingContainer").classList.add("d-none");
        document.getElementById("detailContainer").classList.remove("d-none");

        // 安全地获取数据
        const repoInfo = data.repo_info || {};
        const statistics = data.statistics || {};
        const codeAnalysis = data.code_analysis || [];

        // 显示仓库信息
        displayRepositoryInfo(repoInfo);

        // 显示分析统计
        displayStatistics(statistics);

        // 显示语言分布
        displayLanguageDistribution(repoInfo.languages || {});

        // 显示代码分析结果
        displayCodeAnalysis(codeAnalysis);

        // 更新页面标题
        const repoName = repoInfo.full_name || repoInfo.name || "未知仓库";
        document.title = `${repoName} - 分析详情`;
      }

      // 显示仓库信息
      function displayRepositoryInfo(repoInfo) {
        document.getElementById("repoName").textContent =
          repoInfo.full_name || repoInfo.name || "未知仓库";
        document.getElementById("repoDescription").textContent =
          repoInfo.description || "无描述";
        document.getElementById("mainLanguage").textContent =
          repoInfo.language || "未知";
        document.getElementById("starCount").textContent = repoInfo.stars || 0;
        document.getElementById("forkCount").textContent = repoInfo.forks || 0;
        document.getElementById("createdAt").textContent = formatDate(
          repoInfo.created_at
        );
        document.getElementById("updatedAt").textContent = formatDate(
          repoInfo.updated_at
        );

        // 设置分析时间（从全局数据中获取）
        if (window.analysisData && window.analysisData.analysis_time) {
          document.getElementById("analysisTime").textContent = formatDate(
            window.analysisData.analysis_time
          );
        }
      }

      // 显示统计信息
      function displayStatistics(statistics) {
        document.getElementById("totalFiles").textContent =
          statistics.total_files || 0;

        // 从代码分析中计算函数和类的数量
        let totalFunctions = statistics.total_functions || 0;
        let totalClasses = statistics.total_classes || 0;

        // 如果统计信息中没有函数和类的数量，从代码分析中计算
        if (window.analysisData && window.analysisData.code_analysis) {
          const codeAnalysis = window.analysisData.code_analysis;
          totalFunctions = 0;
          totalClasses = 0;

          codeAnalysis.forEach((file) => {
            if (file.functions) totalFunctions += file.functions.length;
            if (file.classes) totalClasses += file.classes.length;
            if (file.analysis_items) {
              file.analysis_items.forEach((item) => {
                const title = item.title || "";
                if (
                  title.includes("类") ||
                  title.toLowerCase().includes("class")
                ) {
                  totalClasses++;
                } else if (
                  title.includes("函数") ||
                  title.toLowerCase().includes("function")
                ) {
                  totalFunctions++;
                }
              });
            }
          });
        }

        document.getElementById("totalFunctions").textContent = totalFunctions;
        document.getElementById("totalClasses").textContent = totalClasses;
        document.getElementById("languageCount").textContent = Object.keys(
          statistics.languages || {}
        ).length;
      }

      // 显示语言分布
      function displayLanguageDistribution(languages) {
        const container = document.getElementById("languageDistribution");

        if (!languages || Object.keys(languages).length === 0) {
          container.innerHTML = '<p class="text-muted">无语言信息</p>';
          return;
        }

        // 处理两种数据格式：{language: bytes} 或 {language: {bytes, percentage}}
        const languageData = Object.entries(languages)
          .map(([language, data]) => {
            if (typeof data === "object" && data.bytes !== undefined) {
              // 新格式：{language: {bytes, percentage}}
              return {
                language,
                bytes: data.bytes,
                percentage: data.percentage || 0,
              };
            } else if (typeof data === "number") {
              // 旧格式：{language: bytes}
              return {
                language,
                bytes: data,
                percentage: 0, // 需要计算
              };
            }
            return null;
          })
          .filter((item) => item !== null);

        // 如果没有预计算的百分比，则计算
        const totalBytes = languageData.reduce(
          (sum, item) => sum + item.bytes,
          0
        );
        if (totalBytes > 0) {
          languageData.forEach((item) => {
            if (item.percentage === 0) {
              item.percentage = (item.bytes / totalBytes) * 100;
            }
          });
        }

        // 按百分比排序
        languageData.sort((a, b) => b.percentage - a.percentage);

        // 生成HTML
        const languageHtml = languageData
          .map(({ language, bytes, percentage }) => {
            const displayPercentage = percentage.toFixed(1);
            const formattedBytes = formatBytes(bytes);

            // 根据语言设置不同的颜色
            const colorClass = getLanguageColor(language);

            return `
            <div class="language-item mb-3">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <div class="d-flex align-items-center">
                  <span class="language-dot ${colorClass} me-2"></span>
                  <span class="language-name fw-medium">${language}</span>
                </div>
                <div class="text-end">
                  <span class="percentage-text fw-bold">${displayPercentage}%</span>
                  <small class="text-muted d-block">${formattedBytes}</small>
                </div>
              </div>
              <div class="progress" style="height: 6px;">
                <div class="progress-bar ${colorClass}"
                     style="width: ${displayPercentage}%"
                     role="progressbar"
                     aria-valuenow="${displayPercentage}"
                     aria-valuemin="0"
                     aria-valuemax="100">
                </div>
              </div>
            </div>
          `;
          })
          .join("");

        container.innerHTML = languageHtml;
      }

      // 格式化字节数
      function formatBytes(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
      }

      // 根据编程语言获取颜色类
      function getLanguageColor(language) {
        const colors = {
          Python: "bg-primary",
          JavaScript: "bg-warning",
          TypeScript: "bg-info",
          Java: "bg-danger",
          "C++": "bg-secondary",
          C: "bg-dark",
          Go: "bg-success",
          Rust: "bg-warning",
          PHP: "bg-primary",
          Ruby: "bg-danger",
          Swift: "bg-warning",
          Kotlin: "bg-primary",
          "C#": "bg-success",
          HTML: "bg-danger",
          CSS: "bg-info",
          Shell: "bg-dark",
          "Jupyter Notebook": "bg-warning",
          Markdown: "bg-secondary",
          YAML: "bg-info",
          JSON: "bg-success",
        };
        return colors[language] || "bg-secondary";
      }

      // 显示代码分析结果
      function displayCodeAnalysis(codeAnalysis) {
        const container = document.getElementById("codeAnalysisContainer");

        if (!codeAnalysis || codeAnalysis.length === 0) {
          container.innerHTML = '<p class="text-muted">无代码分析结果</p>';
          return;
        }

        // 存储原始数据
        originalAnalysisData = codeAnalysis;
        filteredAnalysisData = [...codeAnalysis];

        // 初始化筛选选项
        initializeFilters(codeAnalysis);

        // 更新分析项目总数
        const totalItems = codeAnalysis.reduce(
          (sum, file) => sum + (file.analysis_items || []).length,
          0
        );
        document.getElementById("analysisCount").textContent = totalItems;

        // 使用新的显示方式
        displayCodeAnalysisData(codeAnalysis);
      }

      // 创建代码元素卡片
      function createElementCard(element, type) {
        const icon = type === "function" ? "fas fa-function" : "fas fa-cube";
        const color = type === "function" ? "success" : "info";

        return `
          <div class="element-card">
            <div class="element-header">
              <i class="${icon} me-2 text-${color}"></i>
              ${element.title}
              <span class="language-badge badge bg-light text-dark ms-2">${
                element.language
              }</span>
            </div>
            <div class="element-content">
              <p class="mb-2">${element.description}</p>
              <div class="code-block">
                <pre><code>${escapeHtml(element.code)}</code></pre>
              </div>
            </div>
          </div>
        `;
      }

      // 创建分析项目卡片
      function createAnalysisItemCard(item, searchTerm = "") {
        const highlightedTitle = highlightSearchTerm(
          item.title || "未知项目",
          searchTerm
        );
        const highlightedDescription = highlightSearchTerm(
          item.description || "无描述",
          searchTerm
        );
        const highlightedCode = item.code
          ? highlightCodeSearchTerm(item.code, searchTerm)
          : "";

        return `
          <div class="element-card">
            <div class="element-header">
              <i class="fas fa-code me-2 text-warning"></i>
              ${highlightedTitle}
              <span class="language-badge badge bg-light text-dark ms-2">${
                item.language || "unknown"
              }</span>
              ${
                item.source
                  ? `<span class="badge bg-secondary ms-2">${item.source}</span>`
                  : ""
              }
            </div>
            <div class="element-content">
              <p class="mb-2">${highlightedDescription}</p>
              ${
                item.code
                  ? `
                <div class="code-block">
                  <pre><code>${highlightedCode}</code></pre>
                </div>
              `
                  : ""
              }
            </div>
          </div>
        `;
      }

      // 显示错误
      function showError(message) {
        document.getElementById("loadingContainer").classList.add("d-none");
        document.getElementById("errorContainer").classList.remove("d-none");
        document.getElementById("errorMessage").textContent = message;
      }

      // 格式化日期
      function formatDate(dateString) {
        if (!dateString) return "-";
        return new Date(dateString).toLocaleString("zh-CN");
      }

      // HTML转义
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // 高亮搜索关键词
      function highlightSearchTerm(text, searchTerm) {
        if (!searchTerm || !text) return escapeHtml(text);

        const escapedText = escapeHtml(text);
        const escapedSearchTerm = escapeHtml(searchTerm);

        // 使用正则表达式进行大小写不敏感的替换
        const regex = new RegExp(
          `(${escapedSearchTerm.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`,
          "gi"
        );
        return escapedText.replace(
          regex,
          '<span class="search-highlight">$1</span>'
        );
      }

      // 高亮代码中的搜索关键词
      function highlightCodeSearchTerm(code, searchTerm) {
        if (!searchTerm || !code) return escapeHtml(code);

        const escapedCode = escapeHtml(code);
        const escapedSearchTerm = escapeHtml(searchTerm);

        // 使用正则表达式进行大小写不敏感的替换，保持代码格式
        const regex = new RegExp(
          `(${escapedSearchTerm.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`,
          "gi"
        );
        return escapedCode.replace(
          regex,
          '<span class="search-highlight">$1</span>'
        );
      }

      // 全局变量存储原始数据
      let originalAnalysisData = [];
      let filteredAnalysisData = [];

      // 搜索和筛选功能
      function toggleSearchPanel() {
        const panel = document.getElementById("searchPanel");
        panel.classList.toggle("d-none");

        if (!panel.classList.contains("d-none")) {
          document.getElementById("searchInput").focus();
        }
      }

      function toggleFilterPanel() {
        toggleSearchPanel(); // 目前搜索和筛选使用同一个面板
      }

      // 初始化筛选选项
      function initializeFilters(analysisData) {
        const languages = new Set();
        const sources = new Set();

        analysisData.forEach((fileAnalysis) => {
          const items = fileAnalysis.analysis_items || [];
          items.forEach((item) => {
            if (item.language) {
              languages.add(item.language);
            }
            if (item.source) {
              // 提取文件名
              const fileName = item.source.split("/").pop().split("#")[0];
              sources.add(fileName);
            }
          });
        });

        // 填充语言筛选器
        const languageFilter = document.getElementById("languageFilter");
        languageFilter.innerHTML = '<option value="">所有语言</option>';
        Array.from(languages)
          .sort()
          .forEach((lang) => {
            languageFilter.innerHTML += `<option value="${lang}">${lang}</option>`;
          });

        // 填充来源文件筛选器
        const sourceFilter = document.getElementById("sourceFilter");
        sourceFilter.innerHTML = '<option value="">所有文件</option>';
        Array.from(sources)
          .sort()
          .forEach((source) => {
            sourceFilter.innerHTML += `<option value="${source}">${source}</option>`;
          });
      }

      // 执行搜索
      function performSearch() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const languageFilter = document.getElementById("languageFilter").value;
        const sourceFilter = document.getElementById("sourceFilter").value;

        filteredAnalysisData = originalAnalysisData
          .map((fileAnalysis) => {
            const filteredItems = (fileAnalysis.analysis_items || []).filter(
              (item) => {
                // 文本搜索
                const matchesSearch =
                  !searchTerm ||
                  (item.title &&
                    item.title.toLowerCase().includes(searchTerm)) ||
                  (item.description &&
                    item.description.toLowerCase().includes(searchTerm)) ||
                  (item.code && item.code.toLowerCase().includes(searchTerm));

                // 语言筛选
                const matchesLanguage =
                  !languageFilter ||
                  (item.language && item.language === languageFilter);

                // 来源文件筛选
                const matchesSource =
                  !sourceFilter ||
                  (item.source && item.source.includes(sourceFilter));

                return matchesSearch && matchesLanguage && matchesSource;
              }
            );

            return {
              ...fileAnalysis,
              analysis_items: filteredItems,
            };
          })
          .filter((fileAnalysis) => fileAnalysis.analysis_items.length > 0);

        // 更新显示
        displayFilteredResults();
        updateSearchStats(searchTerm, languageFilter, sourceFilter);
      }

      // 快速筛选
      function quickFilter(type) {
        const searchInput = document.getElementById("searchInput");
        const languageFilter = document.getElementById("languageFilter");

        // 清除现有筛选
        searchInput.value = "";
        languageFilter.value = "";
        document.getElementById("sourceFilter").value = "";

        switch (type) {
          case "function":
            searchInput.value = "函数";
            break;
          case "class":
            searchInput.value = "类";
            break;
          case "python":
            languageFilter.value = "python";
            break;
          case "javascript":
            languageFilter.value = "javascript";
            break;
        }

        performSearch();
      }

      // 清除筛选
      function clearFilters() {
        document.getElementById("searchInput").value = "";
        document.getElementById("languageFilter").value = "";
        document.getElementById("sourceFilter").value = "";
        performSearch();
      }

      // 清除搜索
      function clearSearch() {
        clearFilters();
        document.getElementById("searchStats").classList.add("d-none");
      }

      // 显示筛选结果
      function displayFilteredResults() {
        const container = document.getElementById("codeAnalysisContainer");

        if (filteredAnalysisData.length === 0) {
          container.innerHTML = '<p class="text-muted">没有找到匹配的结果</p>';
          return;
        }

        // 使用现有的显示逻辑，但使用筛选后的数据
        displayCodeAnalysisData(filteredAnalysisData);
      }

      // 更新搜索统计
      function updateSearchStats(searchTerm, languageFilter, sourceFilter) {
        const totalItems = filteredAnalysisData.reduce(
          (sum, file) => sum + (file.analysis_items || []).length,
          0
        );

        const hasFilters = searchTerm || languageFilter || sourceFilter;
        const statsPanel = document.getElementById("searchStats");

        if (hasFilters) {
          document.getElementById("searchResultCount").textContent = totalItems;
          statsPanel.classList.remove("d-none");
        } else {
          statsPanel.classList.add("d-none");
        }
      }

      // 修改原有的显示函数以支持搜索
      function displayCodeAnalysisData(analysisData) {
        const container = document.getElementById("codeAnalysisContainer");

        // 获取当前搜索词
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase()
          .trim();

        const analysisHtml = analysisData
          .map((fileAnalysis) => {
            const analysisItems = fileAnalysis.analysis_items || [];

            if (analysisItems.length === 0) {
              return "";
            }

            return `
            <div class="file-analysis mb-4">
              <h6 class="text-primary mb-3">
                <i class="fas fa-file-code me-2"></i>
                ${fileAnalysis.file_path || "未知文件"}
              </h6>

              ${
                analysisItems.length > 0
                  ? `
                <h6 class="text-warning mb-2">
                  <i class="fas fa-code me-1"></i>
                  分析项目 (${analysisItems.length})
                </h6>
                ${analysisItems
                  .map((item) => createAnalysisItemCard(item, searchTerm))
                  .join("")}
              `
                  : ""
              }
            </div>
          `;
          })
          .filter((html) => html.trim() !== "")
          .join("");

        container.innerHTML =
          analysisHtml || '<p class="text-muted">无分析结果</p>';
      }
    </script>
  </body>
</html>
